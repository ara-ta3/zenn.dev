---
title: "MySQLで中央値を取得するSQLを書く"
emoji: "📑"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["mysql"]
published: false
---

## 概要

MySQLで文字列の長さを求めるときは `CHAR_LENGTH()` を使います。  
文字数がわかったときにそのテーブルのVARCHAR型なカラムの文字数中央値はいくつなんだろうと思ったのですが、  
`MEDIAN()` のような関数はなかったので、どうしようかと思ったときの備忘録です。  
この記事では、サンプルテーブルを用意して実際にクエリを動かしながら中央値を求めるクエリを使ってみます。  

# 準備

シンプルな `products` というidとname(varchar)のテーブルを用意し、そこのデータにクエリを投げることで中央値を求めてみましょう。  

## サンプルテーブルの作成とデータ投入

```sql
CREATE TABLE products (
  id INT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(255) NOT NULL
);
```

適当に日本語のデータを入れます。  
今回は「めちゃくちゃ長い名前」のふざけたデータも追加してみます。

```sql
INSERT INTO products (name) VALUES
  ('ペン'),
  ('ノート'),
  ('えんぴつ'),
  ('消しゴム'),
  ('机'),
  ('椅子'),
  ('参考書'),
  ('定規'),
  ('コピー用紙'),
  ('ホワイトボードマーカー'),
  ('これは本当に存在するのか誰もわからないけれど世界一長い商品名として登録されてしまったとんでもなくふざけた商品サンプルデータですよろしくお願いします1234567890');

select * from products;
+----+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| id | name                                                                                                                                                                                                                                  |
+----+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|  1 | ペン                                                                                                                                                                                                                                  |
|  2 | ノート                                                                                                                                                                                                                                |
|  3 | えんぴつ                                                                                                                                                                                                                              |
|  4 | 消しゴム                                                                                                                                                                                                                              |
|  5 | 机                                                                                                                                                                                                                                    |
|  6 | 椅子                                                                                                                                                                                                                                  |
|  7 | 参考書                                                                                                                                                                                                                                |
|  8 | 定規                                                                                                                                                                                                                                  |
|  9 | コピー用紙                                                                                                                                                                                                                            |
| 10 | ホワイトボードマーカー                                                                                                                                                                                                                |
| 11 | これは本当に存在するのか誰もわからないけれど世界一長い商品名として登録されてしまったとんでもなくふざけた商品サンプルデータですよろしくお願いします1234567890                                                                          |
+----+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
11 rows in set (0.003 sec)
```

## 各商品の文字数を確認する

`CHAR_LENGTH()` を使えば文字数がわかります。

```sql
mysql> SELECT id, name, CHAR_LENGTH(name) AS len
    -> FROM products;
+----+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----+
| id | name                                                                                                                                                                                                                                  | len |
+----+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----+
|  1 | ペン                                                                                                                                                                                                                                  |   2 |
|  2 | ノート                                                                                                                                                                                                                                |   3 |
|  3 | えんぴつ                                                                                                                                                                                                                              |   4 |
|  4 | 消しゴム                                                                                                                                                                                                                              |   4 |
|  5 | 机                                                                                                                                                                                                                                    |   1 |
|  6 | 椅子                                                                                                                                                                                                                                  |   2 |
|  7 | 参考書                                                                                                                                                                                                                                |   3 |
|  8 | 定規                                                                                                                                                                                                                                  |   2 |
|  9 | コピー用紙                                                                                                                                                                                                                            |   5 |
| 10 | ホワイトボードマーカー                                                                                                                                                                                                                |  11 |
| 11 | これは本当に存在するのか誰もわからないけれど世界一長い商品名として登録されてしまったとんでもなくふざけた商品サンプルデータですよろしくお願いします1234567890                                                                          |  83 |
+----+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----+
11 rows in set (0.003 sec)
```

# 中央値を求める

一旦中央値を確認しておきましょう。  
MySQL 8.0から使えるROW_NUMBERを利用するとわかりやすいので活用しました。  
11個のレコードが存在するので中央値は6番目の値となります。  
つまり `3` ですね。  
```
mysql> select ROW_NUMBER() over (order by len asc) , t.* from (SELECT id, name, CHAR_LENGTH(name) AS len FROM products order by len asc) as t;
+--------------------------------------+----+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----+
| ROW_NUMBER() over (order by len asc) | id | name                                                                                                                                                                                                                                  | len |
+--------------------------------------+----+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----+
|                                    1 |  5 | 机                                                                                                                                                                                                                                    |   1 |
|                                    2 |  1 | ペン                                                                                                                                                                                                                                  |   2 |
|                                    3 |  6 | 椅子                                                                                                                                                                                                                                  |   2 |
|                                    4 |  8 | 定規                                                                                                                                                                                                                                  |   2 |
|                                    5 |  2 | ノート                                                                                                                                                                                                                                |   3 |
|                                    6 |  7 | 参考書                                                                                                                                                                                                                                |   3 |
|                                    7 |  3 | えんぴつ                                                                                                                                                                                                                              |   4 |
|                                    8 |  4 | 消しゴム                                                                                                                                                                                                                              |   4 |
|                                    9 |  9 | コピー用紙                                                                                                                                                                                                                            |   5 |
|                                   10 | 10 | ホワイトボードマーカー                                                                                                                                                                                                                |  11 |
|                                   11 | 11 | これは本当に存在するのか誰もわからないけれど世界一長い商品名として登録されてしまったとんでもなくふざけた商品サンプルデータですよろしくお願いします1234567890                                                                          |  83 |
+--------------------------------------+----+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----+
11 rows in set (0.002 sec)
```

## 方法1: LIMIT + OFFSET で中央値を求める

シンプルに「ソートして真ん中を取る」方法です。  

```sql
SELECT
  AVG(sub.len) AS median_length
FROM (
  SELECT CHAR_LENGTH(name) AS len
  FROM products
  ORDER BY len
  LIMIT 2 - (SELECT COUNT(*) FROM products) % 2    -- 偶数なら2件、奇数なら1件
  OFFSET (SELECT (COUNT(*) - 1) / 2 FROM products) -- 真ん中の位置
) AS sub;


# サブクエリの値確認

mysql> SELECT (COUNT(*) - 1) / 2 FROM products;
+--------------------+
| (COUNT(*) - 1) / 2 |
+--------------------+
|             5.0000 |
+--------------------+
1 row in set (0.002 sec)

mysql> SELECT (SELECT COUNT(*) FROM products) % 2;
+-------------------------------------+
| (SELECT COUNT(*) FROM products) % 2 |
+-------------------------------------+
|                                   1 |
+-------------------------------------+

# 値を展開したクエリ
SELECT
  AVG(sub.len) AS median_length
FROM (
  SELECT CHAR_LENGTH(name) AS len
  FROM products
  ORDER BY len
  LIMIT 1 # = 2 - 1
  OFFSET 5
) AS sub;

# つまり5件除外したところから1件というクエリになりました
```

結果は以下の通りです。  

```
+---------------+
| median_length |
+---------------+
| 3.0           |
+---------------+
```


## 方法2: ウィンドウ関数を使う (MySQL 8.0以上)

より柔軟に書く方法として、ウィンドウ関数 `ROW_NUMBER()` と `COUNT(*) OVER ()` を使います。
集計系の関数を使う場合、通常のGROUP BYでは行をまとめて1行にしますが、OVERを使うと「行をまとめずに」集計結果を各行に付与できます。  

```sql
WITH ordered AS (
  SELECT
    CHAR_LENGTH(name) AS len,
    ROW_NUMBER() OVER (ORDER BY CHAR_LENGTH(name)) AS rn,
    COUNT(*) OVER () AS total_count
  FROM products
)
SELECT
  CASE
    WHEN total_count % 2 = 1 THEN
      MAX(CASE WHEN rn = (total_count + 1) / 2 THEN len END)
    ELSE
      AVG(CASE WHEN rn IN (total_count / 2, total_count / 2 + 1) THEN len END)
  END AS median_length
FROM ordered;
```

結果は以下の通りです。  

```
+---------------+
| median_length |
+---------------+
| 3.0           |
+---------------+
```

# まとめ

`CHAR_LENGTH()` で文字数を取得し、行数が少なければ **LIMIT + OFFSET** でシンプルに、MySQL 8.0 以上なら **ウィンドウ関数**でスマートにかけました。  
なんならOVERもこのタイミング知ったのですが、ROW_NUMBERも組み合わせるとすごい便利に感じました。  
中央値をまた出したくなる機会があると思うので、そのときにまた使いたいと思います。  
